<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="https://i.ibb.co/3MLnNMD/image.png">
<base href="." />
<title>AI D&D</title><style>
<style>
:root {
  --parchment: #f4d03f;
  --ink: #2c3e50;
}

body {
  margin: 0;
  padding: 20px;
  background: #2c3e50;
  font-family: 'Luminari', fantasy;
  color: var(--ink);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.character-creation {
  background: var(--parchment);
  padding: 30px;
  border-radius: 15px;
  margin-bottom: 20px;
  width: 90%;
  max-width: 800px;
}

.stat-input {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
}

.custom-action {
  width: 100%;
  padding: 10px;
  margin-top: 20px;
  font-family: inherit;
  border: 2px solid #34495e;
  border-radius: 8px;
  background: white;
}

.appearance-textarea {
  width: 100%;
  height: 100px;
  padding: 10px;
  margin: 10px 0;
  font-family: inherit;
  border: 2px solid #34495e;
  border-radius: 8px;
  resize: vertical;
  background: white;
}

.game-container {
  background: var(--parchment);
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
  max-width: 800px;
  width: 90%;
  position: relative;
  overflow: hidden;
  display: none;
}

.story-text {
  font-size: 1.2em;
  line-height: 1.6;
  margin-bottom: 20px;
}

.character-sheet {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--parchment);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
}

.dice-container {
  position: fixed;
  bottom: 20px;
  left: 20px;
}

.dice {
  width: 60px;
  height: 60px;
  cursor: pointer;
}

@keyframes roll {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.rolling {
  animation: roll 0.5s linear infinite;
}

.loading-container {
  display: none;
  justify-content: center;
  align-items: center;
  margin: 20px 0;
}

.loading-dot {
  width: 12px;
  height: 12px;
  margin: 0 5px;
  background-color: #34495e;
  border-radius: 50%;
  display: inline-block;
}

@keyframes bounce {
  0%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-10px); }
}

.loading-dot:nth-child(1) { animation: bounce 1s infinite 0s; }
.loading-dot:nth-child(2) { animation: bounce 1s infinite 0.2s; }
.loading-dot:nth-child(3) { animation: bounce 1s infinite 0.4s; }

input, select {
  padding: 5px;
  border-radius: 5px;
  border: 1px solid #34495e;
}

button {
  background: #34495e;
  color: var(--parchment);
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
}
</style>
</head>
<body>
<div class="character-creation" id="characterCreation">
  <h2>Create Your Character</h2>
  <div>
    <label>Name: <input type="text" id="charName"></label>
  </div>
  <div>
    <label>Race: <input type="text" id="charRace" placeholder="Enter your race..."></label>
  </div>
  <div>
    <label>Class: 
      <select id="charClass">
        <option>Fighter</option>
        <option>Wizard</option>
        <option>Rogue</option>
        <option>Cleric</option>
        <option>Ranger</option>
        <option>Warlock</option>
        <option>Artificer</option>
        <option>Bard</option>
        <option>Druid</option>
        <option>Paladin</option>
        <option>Barbarian</option>
      </select>
    </label>
  </div>
  <div>
    <label>Appearance:
      <textarea id="charAppearance" class="appearance-textarea" 
        placeholder="Describe your character's appearance (height, build, notable features, clothing style, etc)..."></textarea>
    </label>
  </div>
  <h3>Stats (Points remaining: <span id="pointsLeft">27</span>)</h3>
  <div id="statInputs"></div>
  <button onclick="startAdventure()">Begin Adventure</button>
</div>

<div class="game-container">
  <div class="story-text" id="storyText"></div>
  <div class="loading-container" id="loadingContainer">
    <div class="loading-dot"></div>
    <div class="loading-dot"></div>
    <div class="loading-dot"></div>
  </div>
  <textarea class="custom-action" id="customAction" placeholder="What would you like to do? Type your action here..."></textarea>
  <button onclick="submitCustomAction()">Submit Action</button>
</div>

<div class="character-sheet" id="characterSheet">
  <h3>Character Sheet</h3>
  <div id="stats"></div>
</div>

<div class="dice-container">
  <svg class="dice" id="d20" viewBox="0 0 100 100">
    <path d="M50 5L95 50L50 95L5 50Z" fill="#34495e" stroke="var(--parchment)" stroke-width="2"/>
    <text x="50" y="55" text-anchor="middle" fill="var(--parchment)" font-size="20">20</text>
  </svg>
</div>

<script>
let stats = {
  strength: 8,
  dexterity: 8,
  constitution: 8,
  intelligence: 8,
  wisdom: 8,
  charisma: 8
};

let character = {
  name: '',
  race: '',
  class: '',
  appearance: ''
};

let currentScene = 0;
let pointsRemaining = 27;

function initializeStatInputs() {
  const statInputs = document.getElementById('statInputs');
  statInputs.innerHTML = '';
  
  Object.keys(stats).forEach(stat => {
    const div = document.createElement('div');
    div.className = 'stat-input';
    div.innerHTML = `
      <label>${stat.charAt(0).toUpperCase() + stat.slice(1)}:</label>
      <button onclick="adjustStat('${stat}', -1)">-</button>
      <span id="${stat}-value">${stats[stat]}</span>
      <button onclick="adjustStat('${stat}', 1)">+</button>
    `;
    statInputs.appendChild(div);
  });
}

function adjustStat(stat, change) {
  const newValue = stats[stat] + change;
  const cost = change > 0 ? getCost(newValue - 1) : -getCost(newValue);
  
  if (newValue >= 8 && newValue <= 15 && pointsRemaining - cost >= 0) {
    stats[stat] = newValue;
    pointsRemaining -= cost;
    document.getElementById(`${stat}-value`).textContent = newValue;
    document.getElementById('pointsLeft').textContent = pointsRemaining;
  }
}

function getCost(value) {
  if (value <= 13) return 1;
  if (value === 14) return 2;
  return 3;
}

function startAdventure() {
  character.name = document.getElementById('charName').value;
  character.race = document.getElementById('charRace').value;
  character.class = document.getElementById('charClass').value;
  character.appearance = document.getElementById('charAppearance').value;
  
  if (!character.name || !character.race || !character.class) {
    alert('Please fill in all character details before starting.');
    return;
  }
  
  document.getElementById('characterCreation').style.display = 'none';
  document.querySelector('.game-container').style.display = 'block';
  
  updateCharacterSheet();
  updateScene();
}

function showLoading() {
  document.getElementById('loadingContainer').style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingContainer').style.display = 'none';
}

async function getAIResponse(context) {
  try {
    showLoading();
    const response = await fetch('/api/ai_completion', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify({
        prompt: `You are a creative and engaging Dungeon Master. Create an immersive D&D scenario response based on the following context:
        
        Character Info:
        - Name: ${character.name}
        - Race: ${character.race}
        - Class: ${character.class}
        - Appearance: ${character.appearance}
        
        ${context.customAction ? `Player's Action: ${context.customAction}` : 'Starting new scene'}
        Current Scene: ${context.currentScene}
        
        Generate a detailed, engaging response that advances the story and responds to the player's action (if any).
        Include descriptive details, potential consequences of actions, and opportunities for further interaction.
        Keep the tone appropriate for a D&D adventure.
        
        <typescript-interface>
        interface Response {
          story: string;
        }
        </typescript-interface>
        
        <example>
        {
          "story": "The ancient stone doors creak open, revealing a dimly lit chamber. Cobwebs stretch between crumbling pillars, and the musty air carries whispers of forgotten tales. Your torch casts dancing shadows on walls covered in mysterious runes. What secrets await in this forgotten place?"
        }
        </example>`,
        data: context
      }),
    });
    
    const result = await response.json();
    hideLoading();
    return result;
  } catch (error) {
    console.error('Error:', error);
    hideLoading();
    return {
      story: "The dungeon master seems to be taking a short rest. Please try your action again."
    };
  }
}

async function updateScene() {
  const scene = await getAIResponse({ 
    currentScene,
    initialScene: true,
    character,
    stats 
  });
  
  if (scene) {
    const storyText = document.getElementById('storyText');
    gsap.to(storyText, {
      opacity: 0,
      duration: 0.3,
      onComplete: () => {
        storyText.textContent = scene.story;
        gsap.to(storyText, {
          opacity: 1,
          duration: 0.3
        });
      }
    });
  }
}

async function submitCustomAction() {
  const actionText = document.getElementById('customAction').value;
  if (actionText.trim()) {
    currentScene++;
    document.getElementById('customAction').value = '';
    
    gsap.to('.game-container', {
      opacity: 0,
      duration: 0.5,
      onComplete: async () => {
        const response = await getAIResponse({ 
          currentScene, 
          customAction: actionText 
        });
        
        if (response) {
          document.getElementById('storyText').textContent = response.story;
        }
        
        gsap.to('.game-container', {
          opacity: 1,
          duration: 0.5
        });
      }
    });
  }
}

function updateCharacterSheet() {
  const statsDiv = document.getElementById('stats');
  statsDiv.innerHTML = `
    <div>Name: ${character.name}</div>
    <div>Race: ${character.race}</div>
    <div>Class: ${character.class}</div>
    <div>Appearance: ${character.appearance}</div>
    <hr>
  `;
  
  for (const [stat, value] of Object.entries(stats)) {
    const statDiv = document.createElement('div');
    statDiv.textContent = `${stat.charAt(0).toUpperCase() + stat.slice(1)}: ${value}`;
    statsDiv.appendChild(statDiv);
  }
}

function rollDice() {
  const d20 = document.getElementById('d20');
  d20.classList.add('rolling');
  
  setTimeout(() => {
    const roll = Math.floor(Math.random() * 20) + 1;
    d20.querySelector('text').textContent = roll;
    d20.classList.remove('rolling');
  }, 1000);
}

document.getElementById('d20').addEventListener('click', rollDice);

// Initialize the game
initializeStatInputs();

</script>
</body></html>
