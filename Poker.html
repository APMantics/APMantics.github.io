<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="https://www.vecteezy.com/free-png/poker-chips">
<base href="." />
<title>LVB Poker Night</title><style>
:root {
  --table-green: #35654d;
  --card-red: #d42030;
  --card-black: #1a1a1a;
}

body {
  margin: 0;
  padding: 20px;
  font-family: 'IBM Plex Sans', sans-serif;
  background: #1a1a1a;
  color: white;
}

#poker-table {
  width: 800px;
  height: 400px;
  background: var(--table-green);
  border-radius: 200px;
  position: relative;
  margin: 50px auto;
  border: 20px solid #234535;
  box-shadow: 0 10px 20px rgba(0,0,0,0.5);
}

.player-spot {
  position: absolute;
  width: 120px;
  text-align: center;
}

.player-spot img {
  width: 50px;
  height: 50px;
  border-radius: 25px;
  border: 2px solid gold;
}

.player-chips {
  font-weight: bold;
  color: gold;
}

.player-cards {
  display: flex;
  justify-content: center;
  gap: 5px;
  margin-top: 5px;
}

.card {
  width: 40px;
  height: 60px;
  background: white;
  border-radius: 5px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.red {
  color: var(--card-red);
}

.black {
  color: var(--card-black);
}

#community-cards {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  gap: 10px;
}

#pot {
  position: absolute;
  top: 30%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-weight: bold;
  color: gold;
}

#controls {
  text-align: center;
  margin-top: 20px;
}

button {
  background: #333;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  margin: 0 5px;
  cursor: pointer;
  font-family: inherit;
}

button:hover {
  background: #444;
}

button:disabled {
  background: #222;
  cursor: not-allowed;
}

#bet-input {
  width: 100px;
  padding: 8px;
  margin-right: 10px;
}

.eliminated {
  opacity: 0.5;
  pointer-events: none;
}
</style>
</head>
<body>
<div id="poker-table">
  <div id="pot">Pot: $0</div>
  <div id="community-cards"></div>
</div>
<div id="controls">
  <input type="number" id="bet-input" min="1" step="1" value="10">
  <button id="bet-btn" disabled>Bet</button>
  <button id="call-btn" disabled>Call</button>
  <button id="fold-btn" disabled>Fold</button>
  <button id="start-btn">Start Game</button>
  <button id="rejoin-btn" style="display: none;">Rejoin with $100</button>
</div>

<script>
const room = new WebsimSocket();
let gameState = {
  players: {},
  deck: [],
  communityCards: [],
  pot: 0,
  currentTurn: null,
  phase: 'waiting', // waiting, preflop, flop, turn, river, showdown
  lastBet: 0,
  eliminatedPlayers: new Set()
};

const POSITIONS = [
  {top: '80%', left: '50%'},  // bottom
  {top: '60%', left: '85%'},  // bottom right
  {top: '20%', left: '85%'},  // top right
  {top: '10%', left: '50%'},  // top
  {top: '20%', left: '15%'},  // top left
  {top: '60%', left: '15%'}   // bottom left
];

function createDeck() {
  const suits = ['♥', '♦', '♣', '♠'];
  const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
  const deck = [];
  
  for (const suit of suits) {
    for (const value of values) {
      deck.push({suit, value});
    }
  }
  return shuffle(deck);
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function checkForElimination(clientId) {
  if (gameState.players[clientId] && gameState.players[clientId].chips <= 0) {
    gameState.eliminatedPlayers.add(clientId);
    delete gameState.players[clientId];
    
    if (clientId === room.party.client.id) {
      document.getElementById('rejoin-btn').style.display = 'inline-block';
      document.getElementById('bet-btn').disabled = true;
      document.getElementById('call-btn').disabled = true;
      document.getElementById('fold-btn').disabled = true;
    }

    // If it was eliminated player's turn, move to next player
    if (gameState.currentTurn === clientId) {
      const remainingPlayers = Object.keys(gameState.players);
      if (remainingPlayers.length > 0) {
        gameState.currentTurn = remainingPlayers[0];
      }
    }
  }
}

function renderTable() {
  // Clear existing players
  const table = document.getElementById('poker-table');
  const existingSpots = document.querySelectorAll('.player-spot');
  existingSpots.forEach(spot => spot.remove());

  // Render each player
  let positionIndex = 0;
  for (const clientId in gameState.players) {
    const player = gameState.players[clientId];
    const position = POSITIONS[positionIndex];
    
    const playerSpot = document.createElement('div');
    playerSpot.className = 'player-spot';
    if (gameState.eliminatedPlayers.has(clientId)) {
      playerSpot.classList.add('eliminated');
    }
    playerSpot.style.top = position.top;
    playerSpot.style.left = position.left;
    playerSpot.style.transform = 'translate(-50%, -50%)';
    
    playerSpot.innerHTML = `
      <img src="https://images.websim.ai/avatar/${player.username}" alt="${player.username}">
      <div>${player.username}</div>
      <div class="player-chips">$${player.chips}</div>
      <div class="player-cards">
        ${player.cards.map(card => `
          <div class="card ${['♥', '♦'].includes(card.suit) ? 'red' : 'black'}">
            ${card.value}${card.suit}
          </div>
        `).join('')}
      </div>
    `;
    
    table.appendChild(playerSpot);
    positionIndex++;
  }

  // Update community cards
  const communityCardsEl = document.getElementById('community-cards');
  communityCardsEl.innerHTML = gameState.communityCards.map(card => `
    <div class="card ${['♥', '♦'].includes(card.suit) ? 'red' : 'black'}">
      ${card.value}${card.suit}
    </div>
  `).join('');

  // Update pot
  document.getElementById('pot').textContent = `Pot: $${gameState.pot}`;

  // Update controls
  const isMyTurn = gameState.currentTurn === room.party.client.id;
  const isEliminated = gameState.eliminatedPlayers.has(room.party.client.id);
  document.getElementById('bet-btn').disabled = !isMyTurn || isEliminated;
  document.getElementById('call-btn').disabled = !isMyTurn || isEliminated;
  document.getElementById('fold-btn').disabled = !isMyTurn || isEliminated;
  document.getElementById('rejoin-btn').style.display = isEliminated ? 'inline-block' : 'none';
}

function startGame() {
  if (Object.keys(room.party.peers).length < 2) {
    alert('Need at least 2 players to start!');
    return;
  }

  gameState.deck = createDeck();
  gameState.phase = 'preflop';
  gameState.pot = 0;
  gameState.communityCards = [];
  gameState.players = {};
  gameState.eliminatedPlayers = new Set();

  // Deal cards to players
  Object.keys(room.party.peers).forEach((clientId, index) => {
    if (!gameState.eliminatedPlayers.has(clientId)) {
      gameState.players[clientId] = {
        username: room.party.peers[clientId].username,
        chips: 100,
        cards: [gameState.deck.pop(), gameState.deck.pop()],
        folded: false
      };
    }
  });

  // Set first player
  gameState.currentTurn = Object.keys(gameState.players)[0];

  // Broadcast game state
  room.send({
    type: 'gameState',
    state: gameState
  });
}

function rejoinGame() {
  if (gameState.players[room.party.client.id]) return;
  
  gameState.eliminatedPlayers.delete(room.party.client.id);
  gameState.players[room.party.client.id] = {
    username: room.party.peers[room.party.client.id].username,
    chips: 100,
    cards: [],
    folded: true
  };

  document.getElementById('rejoin-btn').style.display = 'none';
  
  room.send({
    type: 'gameState',
    state: gameState
  });
}

document.getElementById('start-btn').addEventListener('click', startGame);
document.getElementById('rejoin-btn').addEventListener('click', rejoinGame);

document.getElementById('bet-btn').addEventListener('click', () => {
  if (gameState.currentTurn !== room.party.client.id) return;
  
  const betAmount = parseInt(document.getElementById('bet-input').value);
  if (isNaN(betAmount) || betAmount <= 0) return;

  const player = gameState.players[room.party.client.id];
  if (betAmount > player.chips) {
    alert('You cannot bet more than you have!');
    return;
  }

  player.chips -= betAmount;
  gameState.pot += betAmount;
  gameState.lastBet = betAmount;

  checkForElimination(room.party.client.id);

  // Move to next player
  const playerIds = Object.keys(gameState.players);
  const currentIndex = playerIds.indexOf(gameState.currentTurn);
  gameState.currentTurn = playerIds[(currentIndex + 1) % playerIds.length];

  room.send({
    type: 'gameState',
    state: gameState
  });
});

document.getElementById('fold-btn').addEventListener('click', () => {
  if (gameState.currentTurn !== room.party.client.id) return;

  gameState.players[room.party.client.id].folded = true;

  // Move to next player
  const playerIds = Object.keys(gameState.players);
  const currentIndex = playerIds.indexOf(gameState.currentTurn);
  gameState.currentTurn = playerIds[(currentIndex + 1) % playerIds.length];

  room.send({
    type: 'gameState',
    state: gameState
  });
});

room.onmessage = (event) => {
  const data = event.data;
  if (data.type === 'gameState') {
    gameState = data.state;
    // Convert eliminatedPlayers back to Set (it gets converted to array during transmission)
    gameState.eliminatedPlayers = new Set(gameState.eliminatedPlayers);
    renderTable();
  }
};

// Initial render
renderTable();
</script>
</body>
</html>
